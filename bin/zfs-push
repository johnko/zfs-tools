#!/bin/sh

FIRSTSENDOPT="send -pvR"
FIRSTRECVOPT="recv -vudF"
INCREMENTSEND="send -pvR -I"
INCREMENTRECV="recv -vud"

if [ -z "${3}" ]; then
    echo "Usage: $0  snapshot  remote_server:remote_port target_pool [last_snapshot]"
    echo "use - as remote_server for localhost"
    exit 1
fi

FIRSTSNAP="${1}"

if [ "x-" = "x${2}" ]; then
    REMOTE_CONNECTION=""
else
    if echo "${2}" | grep ':' >/dev/null 2>&1 ; then
        REMOTE_HOST=$( echo "${2}" | cut -f1 -d: )
        REMOTE_PORT=$( echo "${2}" | cut -f2 -d: )
    else
        REMOTE_HOST="${2}"
        REMOTE_PORT=22
    fi
    REMOTE_CONNECTION="ssh -p ${REMOTE_PORT} ${REMOTE_HOST}"
fi

RECVPOOL="${3}"

if [ "x" = "x${4}" ]; then
    unset LASTSNAP
else
    LASTSNAP="${4}"
fi

if [ -n "$LASTSNAP" ]; then
    echo "zfs ${INCREMENTSEND} ${FIRSTSNAP} ${LASTSNAP} | ${REMOTE_CONNECTION} zfs ${INCREMENTRECV} ${RECVPOOL}"
          zfs ${INCREMENTSEND} ${FIRSTSNAP} ${LASTSNAP} | ${REMOTE_CONNECTION} zfs ${INCREMENTRECV} ${RECVPOOL} || exit $?
else
    echo "zfs ${FIRSTSENDOPT} ${FIRSTSNAP} | ${REMOTE_CONNECTION} zfs ${FIRSTRECVOPT} ${RECVPOOL}"
          zfs ${FIRSTSENDOPT} ${FIRSTSNAP} | ${REMOTE_CONNECTION} zfs ${FIRSTRECVOPT} ${RECVPOOL} || exit $?
fi
